---
title: 程序优化初试
date: 2019-05-09 22:37:16
tags: 程序优化 csapp
keywords:
description:


---

# 关于程序优化

我们平时都写程序，但是不同的人写出来的代码质量却参差不齐，从如下几方面考虑：

- 程序的可扩展性
- 程序的健壮性
- 程序的性能

今天我来就来说一下程序的性能。 最近在读csapp(深入理解计算机系统),读到第五章的时候觉得作者写的很棒， 于是总结一下，分享给大家。

首先介绍一下程序是如何在计算机中运行的，我们编写的代码，最终会以机器码在计算机中运行。以C语言为例，

C语言->编译得到汇编代码->优化汇编代码->汇编代码为目标文件->链接程序为可执行文件

我们今天主要关注前三个阶段，前三个阶段是顺序的，C语言决定了汇编代码长什么样子，汇编代码决定了能否被编译器优化，因此C语言的写法就显得尤为重要了。

我们现在主要介绍一下书中说的集中优化

## 消除低效率循环

试想，有如下函数：

```c
int test(char* c){
  for(int i = 0; i < strlen(c); i++){
    //do something
  }
}
```

大家想一想，上面的代码有什么问题吗？

```asm
LBB0_2:                                 ## =>This Inner Loop Header: Depth=1
        xorl    %eax, %eax
        movq    %r14, %rdi
        movl    %ebx, %esi
        callq   _printf
        incq    %rbx
        movq    %r15, %rdi
        callq   _strlen
        cmpq    %rbx, %rax
        ja      LBB0_2
```

上图是代码被编译成汇编语言之后的关于循环的一部分，从中可以看到 cmpq之后会再次跳转到LLB0_2 ，而LLB0_2 会再次callq  _strlen，call代价很高，所以我们针对这一点对上述程序进行优化，

```c
int test(char* c){
  int length = strlen(c)
  for(int i = 0; i < length; i++){
    //do something
  }
}
```

上述代码的call  _strlen被挪到了循环外面，提高了程序性能。

## 消除不必要的内存引用

内存引用需要寻址， 内存虽然比外部IO快很多，但是相对于CPU内的寄存器来说还是要慢很多的。所以要尽量减少程序中不合理的内存引用。考虑如下代码:

```c
#include <stdio.h>
#include <string.h>

int test(int* dest, int n){
  for(int i = 0; i < n; i++){
    //do something
    *dest = *dest + 100;
  }
  return 0;
}
```

上面的代码看起来逻辑上是没有问题的，但是我们仔细思考一下c代码下面的运行逻辑：

c指针本质上是进行一次内存寻址，上面咱们也说过内存寻址相对于寄存器来说太慢了，所以我们可以将上述代码优化一下：

```c
#include <stdio.h>
#include <string.h>

int test(int* dest, int n){
  int acc = *dest;
  for(int i = 0; i < n; i++){
    //do something
    acc = acc + 100;
  }
  *dest = acc;
  return 0;
}
```

经过这么改造， 将对内存的引用移到了循环外部， 如果n很大的话，对性能提升来说还是很好的。




